# Brocade Stack OS Discovery - FastIron + ICX stackable switches
# Foundry enterprise OID only: .1.3.6.1.4.1.1991
# OIDs VERIFIED against FCX648 6-unit stack running IronWare 08.0.30uT7f1
# Testing date: 2026-02-04
#
# IMPORTANT: Stacked vs Standalone Detection
#   OID: .1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1 (snStackingOperUnitRole for unit 1)
#   Returns: INTEGER 2, 3, or 4 on stacking systems (active, standby, member)
#            INTEGER 5 on standalone systems
#   Verified on: FCX648 stacks (IronWare 08.0.30u), ICX switches, multiple deployments
#
# IMPORTANT: Power supply tables are mutually exclusive:
#   - snChasPwrSupply2Table: Stacked (unit.ps indexing)
#   - snChasPwrSupplyTable: Standalone (ps indexing only)
---
mib: FOUNDRY-SN-AGENT-MIB
modules:
  mempools:
    data:
      # System-wide DRAM (verified on IronWare 08.0.30u)
      # Using numerical OIDs because LibreNMS MIB can't resolve symbolic names
      # OID .1.3.6.1.4.1.1991.1.1.2.1.54.0 = Total DRAM (bytes)
      # OID .1.3.6.1.4.1.1991.1.1.2.1.55.0 = Free DRAM (bytes)
      # OID .1.3.6.1.4.1.1991.1.1.2.1.53.0 = DRAM Utilization (percent)
      - total: .1.3.6.1.4.1.1991.1.1.2.1.54.0
        free: .1.3.6.1.4.1.1991.1.1.2.1.55.0
        descr: 'System Memory'
  os:
    hardware_mib: FOUNDRY-SN-ROOT-MIB
    sysDescr_regex: '/(?:IronWare|FastIron) Version (?<version>[\d.]+[a-z\d]*)/'
    hardware_regex: '/(?:FCX|FWS|FLS|ICX)\d*[A-Z0-9-]*/i'
    serial: FOUNDRY-SN-AGENT-MIB::snChasSerNum.0
    version: FOUNDRY-SN-AGENT-MIB::snAgImgVer.0
  processors:
    data:
      # Per-unit CPU utilization (works on IronWare 08.0.30u)
      # Index format: {unit}.{slot}.{cpu_num}.{interval}
      # Filter for 1-second interval only (interval=1)
      # OID .1.3.6.1.4.1.1991.1.1.2.11.1.1.5 = snAgentCpuUtilPercent
      # OID .1.3.6.1.4.1.1991.1.1.2.11.1.1.3 = snAgentCpuUtilInterval
      - oid: FOUNDRY-SN-AGENT-MIB::snAgentCpuUtilTable
        value: FOUNDRY-SN-AGENT-MIB::snAgentCpuUtilPercent
        num_oid: '.1.3.6.1.4.1.1991.1.1.2.11.1.1.5.{{ $index }}'
        descr: 'Unit {{ $subindex0 }}.{{ $subindex1 }} CPU Utilization'
        index: '{{ $index }}'
  sensors:
    temperature:
      data:
        # Module Temperatures - Per-unit sensor table (snAgentTemp2Table)
        # Uses actual sensor descriptions from MIB (CPU, MAC 1, MAC 2)
        # Format: "Unit X: <description>" for clear identification
        # Only for stacking systems (skip if standalone)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentTemp2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentTemp2Value
          divisor: 2
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.3.1.5.{{ $index }}'
          descr: 'Unit {{ $subindex0 }}: {{ FOUNDRY-SN-AGENT-MIB::snAgentTemp2SensorDescr }}'
          index: '{{ $index }}'
          group: 'Module Temperatures'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
        # Fallback for standalone units (snAgentTempTable)
        # Only for standalone systems (skip if stacking)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentTempTable
          value: FOUNDRY-SN-AGENT-MIB::snAgentTempValue
          divisor: 2
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.1.1.4.{{ $index }}'
          descr: '{{ FOUNDRY-SN-AGENT-MIB::snAgentTempSensorDescr }}'
          index: '{{ $index }}'
          group: 'Module Temperatures'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "!="
              value: 5
    state:
      data:
        # Power Supply Status - Table 1 (standard/standalone)
        # Returns: 1=other, 2=normal, 3=failure
        # Only for standalone units (skip if stacking system)
        - oid: FOUNDRY-SN-AGENT-MIB::snChasPwrSupplyTable
          value: FOUNDRY-SN-AGENT-MIB::snChasPwrSupplyOperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.1.1.3.{{ $index }}'
          descr: 'Power Supply {{ $index }}'
          index: '{{ $index }}'
          group: 'Power Supply Status'
          state_name: snChasPwrSupplyOperStatus
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "!="
              value: 5
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: normal, graph: 0, generic: 0}
            - {value: 3, descr: failure, graph: 0, generic: 2}
        # Power Supply Status - Table 2 (stacked configurations)
        # Index format: {unit}.{ps_number} (e.g., 1.1, 1.2, 2.1, 2.2)
        # Returns: 1=other, 2=normal, 3=failure
        # Only for stacking systems (skip if standalone)
        - oid: FOUNDRY-SN-AGENT-MIB::snChasPwrSupply2Table
          value: FOUNDRY-SN-AGENT-MIB::snChasPwrSupply2OperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.2.1.4.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Power Supply {{ $subindex1 }}'
          index: '{{ $index }}'
          group: 'Power Supply Status'
          state_name: snChasPwrSupply2OperStatus
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: normal, graph: 0, generic: 0}
            - {value: 3, descr: failure, graph: 0, generic: 2}
        # Fan Status - Table 1 (standard/standalone)
        # Returns: 1=other, 2=normal, 3=failure
        - oid: FOUNDRY-SN-AGENT-MIB::snChasFanTable
          value: FOUNDRY-SN-AGENT-MIB::snChasFanOperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.1.1.3.{{ $index }}'
          descr: 'Fan {{ $index }}'
          index: '{{ $index }}'
          group: 'Fan Status'
          state_name: snChasFanOperStatus
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "!="
              value: 5
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: normal, graph: 0, generic: 0}
            - {value: 3, descr: failure, graph: 0, generic: 2}
        # Fan Status - Table 2 (stacked configurations)
        # Index format: {unit}.{fan_index} (e.g., 1.1, 1.2, 2.1, 2.2)
        # Returns: 1=other, 2=normal, 3=failure
        - oid: FOUNDRY-SN-AGENT-MIB::snChasFan2Table
          value: FOUNDRY-SN-AGENT-MIB::snChasFan2OperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.2.1.4.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Fan {{ $subindex1 }}'
          index: '{{ $index }}'
          group: 'Fan Status'
          state_name: snChasFan2OperStatus
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: normal, graph: 0, generic: 0}
            - {value: 3, descr: failure, graph: 0, generic: 2}

        # Board Module Status - Per-unit board operational status (stacked)
        # Index format: {unit}.{slot} (e.g., 1.1, 2.1, 3.1)
        # Returns: 0=empty, 2=goingDown, 3=rejected, 4=bad, 8=configured, 9=comingUp, 10=running
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentBrd2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentBrd2ModuleStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.2.1.6.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Module {{ $subindex1 }} Status'
          index: '{{ $index }}'
          group: 'Module Status'
          state_name: snAgentBrd2ModuleStatus
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 0, descr: empty, graph: 0, generic: 3}
            - {value: 2, descr: goingDown, graph: 0, generic: 2}
            - {value: 3, descr: rejected, graph: 0, generic: 2}
            - {value: 4, descr: bad, graph: 0, generic: 2}
            - {value: 8, descr: configured, graph: 0, generic: 1}
            - {value: 9, descr: comingUp, graph: 0, generic: 1}
            - {value: 10, descr: running, graph: 0, generic: 0}
        # Board Redundancy Status - Per-unit redundancy status (stacked)
        # Index format: {unit}.{slot} (e.g., 1.1, 2.1, 3.1)
        # Returns: 1=other, 2=active, 3=standby, 4=crashed, 5=comingUp
        # Skip sensors with 'other' status (not meaningful for monitoring)
        # Only for stacking systems (skip if standalone)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentBrd2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentBrd2RedundantStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.2.1.7.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Module {{ $subindex1 }} Redundancy Status'
          index: '{{ $index }}'
          group: 'Module Status'
          state_name: snAgentBrd2RedundantStatus
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
            - oid: "FOUNDRY-SN-AGENT-MIB::snAgentBrd2RedundantStatus"
              op: "="
              value: 1
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: active, graph: 0, generic: 0}
            - {value: 3, descr: standby, graph: 0, generic: 0}
            - {value: 4, descr: crashed, graph: 0, generic: 2}
            - {value: 5, descr: comingUp, graph: 0, generic: 1}

        # Stack Configuration State - DISABLED
        # This OID does NOT exist on firmware 08.0.30u
        # Commented out to prevent discovery errors
        # - oid: FOUNDRY-SN-SWITCH-GROUP-MIB::snStackingGlobalConfigState
        #   value: FOUNDRY-SN-SWITCH-GROUP-MIB::snStackingGlobalConfigState
        #   num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.1.1.0'
        #   descr: 'Stack Configuration'
        #   group: 'Stack Status'
        #   state_name: snStackingGlobalConfigState
        #   states:
        #     - { value: 0, descr: disabled, graph: 0, generic: 3 }
        #     - { value: 1, descr: enabled, graph: 1, generic: 0 }
        #     - { value: 2, descr: unsupported, graph: 0, generic: 2 }

        # Stack Unit State - Verified working on 6-unit stack
        # Returns: 1=local (master), 2=remote (members)
        # Only for stacking systems (skip if standalone)
        - oid: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitTable
          value: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitState
          num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.5.{{ $index }}'
          descr: 'Unit {{ $index }} Topology'
          group: 'Stack Topology'
          state_name: snStackingOperUnitState
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 1, descr: local, graph: 0, generic: 0}
            - {value: 2, descr: remote, graph: 0, generic: 0}
            - {value: 3, descr: reserved, graph: 0, generic: 1}
            - {value: 4, descr: empty, graph: 0, generic: 2}

        # Stack Unit Role - Verified working on 6-unit stack
        # Returns: 2=active (master), 3=standby, 4=member, 5=standalone
        # Only for stacking systems (skip if standalone)
        - oid: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitTable
          value: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitRole
          num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.{{ $index }}'
          descr: 'Unit {{ $index }} Role'
          group: 'Stack Topology'
          state_name: snStackingOperUnitRole
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: active, graph: 0, generic: 0}
            - {value: 3, descr: standby, graph: 0, generic: 0}
            - {value: 4, descr: member, graph: 0, generic: 0}
            - {value: 5, descr: standalone, graph: 0, generic: 0}

    power:
      data:
        # PoE Per-Unit Capacity - Maximum power available per unit
        # OID: .1.3.6.1.4.1.1991.1.1.2.14.4.1.1.2 (snAgentPoeUnitMaxPower)
        # Units: milliwatts (converted to watts via divisor)
        # Only available on PoE-capable hardware
        # Using numerical OIDs because FOUNDRY-POE-MIB may not resolve on all systems
        # Walk the TABLE (.4.1) not the ENTRY (.4.1.1) for proper index resolution
        - oid: .1.3.6.1.4.1.1991.1.1.2.14.4.1
          value: .1.3.6.1.4.1.1991.1.1.2.14.4.1.1.2
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.4.1.1.2.{{ $index }}'
          descr: 'Unit {{ $index }} PoE Capacity'
          index: '{{ $index }}'
          group: 'PoE Power Budget'
          low_limit: 0
          divisor: 1000

        # PoE Per-Unit Consumption - Current power consumption per unit
        # OID: .1.3.6.1.4.1.1991.1.1.2.14.4.1.1.3 (snAgentPoeUnitConsumedPower)
        # Units: milliwatts (converted to watts via divisor)
        # Only available on PoE-capable hardware
        # Using numerical OIDs because FOUNDRY-POE-MIB may not resolve on all systems
        # Walk the TABLE (.4.1) not the ENTRY (.4.1.1) for proper index resolution
        - oid: .1.3.6.1.4.1.1991.1.1.2.14.4.1
          value: .1.3.6.1.4.1.1991.1.1.2.14.4.1.1.3
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.4.1.1.3.{{ $index }}'
          descr: 'Unit {{ $index }} PoE Consumption'
          index: '{{ $index }}'
          group: 'PoE Power Budget'
          low_limit: 0
          divisor: 1000

        # PoE Per-Port sensors moved to PHP (BrocadeStack.php)
        # PHP implementation provides:
        # - Proper port name mapping (1/1/1 instead of raw index)
        # - Automatic port_id association for individual port pages
        # - Correct placement (port pages, not overview)

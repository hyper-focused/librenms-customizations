# Brocade Stack OS Discovery
# Single unified discovery: FastIron (FCX, FWS, FLS, etc.) + ICX stackable switches
# Shared MIBs and logic for both platforms; stack-aware per-unit discovery
---
mib: FOUNDRY-SN-AGENT-MIB:FOUNDRY-SN-SWITCH-GROUP-MIB:FOUNDRY-SN-STACKING-MIB:Brocade-REG-MIB:FOUNDRY-SN-ROOT-MIB
modules:
    mempools:
        additional_oids:
            oids:
                - FOUNDRY-SN-AGENT-MIB::snAgentBrdMainBrdDescription
                - FOUNDRY-SN-AGENT-MIB::snAgentConfigModuleDescription
        data:
            -
                # Global system memory (stack master)
                total: FOUNDRY-SN-AGENT-MIB::snAgSystemDRAMTotal
                free: FOUNDRY-SN-AGENT-MIB::snAgSystemDRAMFree
                descr: 'System Memory'
                type: brocade-system
            -
                # Per-unit/per-module memory (stack-aware via index)
                # Index represents unit/module in stacked systems
                total: FOUNDRY-SN-AGENT-MIB::snAgentBrdMemoryTotal
                percent_used: FOUNDRY-SN-AGENT-MIB::snAgentBrdMemoryUtil100thPercent
                type: brocade-dyn
                descr: 'Unit {{ $index }} {{ FOUNDRY-SN-AGENT-MIB::snAgentBrdMainBrdDescription }}'

    os:
        hardware_mib: FOUNDRY-SN-ROOT-MIB
        # Extract version from sysDescr
        # Matches: "IronWare Version 08.0.30uT7f1" or "FastIron Version 08.0.95"
        sysDescr_regex: '/(?:IronWare|FastIron) Version (?<version>[\d.]+[a-zA-Z0-9]*)/i'
        # Extract hardware from sysDescr (FastIron + ICX model names)
        # Matches: FCX648, FWS, FLS, ICX6450-48, ICX7150-48P, etc.
        hardware:
            - FOUNDRY-SN-AGENT-MIB::snChasUnitDescription.1
        hardware_regex: '/(?:FCX|FWS|FLS|ICX)\d*[A-Z0-9-]*/i'
        serial: FOUNDRY-SN-AGENT-MIB::snChasSerNum.0
        version: FOUNDRY-SN-AGENT-MIB::snAgImgVer.0

    sensors:

        # PoE disabled by default: avoids 0-value PoE sensors on device overview for non-PoE devices.
        # Re-add via conditional PHP (probe snAgentPoeGblPowerCapacityTotal) for PoE models if needed.
        count:
            data: []
        power:
            data: []

        # Temperature monitoring (stack-aware)
        temperature:
            data:
                -
                    # Legacy temperature table (use only if Temp2 not available)
                    oid: snAgentTempTable
                    value: snAgentTempValue
                    divisor: 2
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.1.1.4.{{ $index }}'
                    descr: snAgentTempSensorDescr
                    index: '{{ $index }}'
                    group: 'Module Temperatures'
                    skip_values:
                        -
                            oid: snAgentTemp2SensorDescr.1.1.1
                            op: 'exists'
                            value: true
                -
                    # Stack-aware temperature table (per-unit indexed)
                    # Index format: unit.slot.sensor (e.g., 1.1.1 = unit 1, slot 1, sensor 1)
                    # subindex0 = unit ID, subindex1 = slot, subindex2 = sensor
                    oid: snAgentTemp2Table
                    value: snAgentTemp2Value
                    divisor: 2
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.3.1.5.{{ $index }}'
                    descr: 'Unit {{ $subindex0 }}/{{ $subindex1 }} {{ $snAgentTemp2SensorDescr }}'
                    index: '{{ $index }}'
                    group: 'Stack Unit Temperatures'

        # CPU utilization monitoring - stack-aware
        # Provides per-unit CPU monitoring for stacked systems
        load:
            data:
                -
                    oid: snAgentCpuUtilTable
                    value: snAgentCpuUtilPercent
                    index: 'snAgentCpuUtilPercent.{{ $index }}'
                    descr: 'CPU {{ $index }}'

        # State sensors (PSU, Fan, Stack)
        state:
            data:
                # -
                #     # Power Supply monitoring - Stack-aware version (for newer firmware)
                #     # Index format: unit.psu (e.g., 1.1 = unit 1 PSU 1, 2.1 = unit 2 PSU 1)
                #     # Table: snChasPwrSupply2Table (.1.3.6.1.4.1.1991.1.1.1.2.2) - stack-wide PSU data
                #     # NOTE: Not available on IronWare 08.0.30uT7f1 - use snChasPwrSupplyTable instead
                #     oid: snChasPwrSupply2Table
                #     value: snChasPwrSupply2OperStatus
                #     num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.2.1.4.{{ $index }}'
                #     descr: 'Unit {{ $snChasPwrSupply2Unit }} {{ $snChasPwrSupply2Description }}'
                #     index: '{{ $index }}'
                #     group: Power Supply
                #     state_name: snChasPwrSupply2OperStatus
                #     states:
                #         - { value: 1, descr: other, graph: 0, generic: 3 }
                #         - { value: 2, descr: normal, graph: 1, generic: 0 }
                #         - { value: 3, descr: failure, graph: 0, generic: 2 }
                #     skip_values:
                #         -
                #             # Skip if this is not a stacking system (check sysDescr for "Stacking System")
                #             oid: SNMPv2-MIB::sysDescr.0
                #             op: 'not_contains'
                #             value: 'Stacking System'
                -
                    # Power Supply monitoring - Stack-aware version (WORKS on IronWare 08.0.30uT7f1!)
                    # Index format: unit.psu (e.g., 1.1 = unit 1 PSU 1, 2.1 = unit 2 PSU 1)
                    # Table: snChasPwrSupply2Table (.1.3.6.1.4.1.1991.1.1.1.2.2) - stack-wide PSU data
                    # Provides monitoring for ALL 6 stack units on your FCX648!
                    oid: snChasPwrSupply2Table
                    value: snChasPwrSupply2OperStatus
                    num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.2.1.4.{{ $index }}'
                    descr: 'Unit {{ $snChasPwrSupply2Unit }} {{ $snChasPwrSupply2Description }}'
                    index: '{{ $index }}'
                    group: Power Supply
                    state_name: snChasPwrSupply2OperStatus
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: normal, graph: 1, generic: 0 }
                        - { value: 3, descr: failure, graph: 0, generic: 2 }
                    skip_values:
                        -
                            # Skip if stacking is NOT enabled (use standalone OIDs instead)
                            # Check stack configuration state: 1=enabled, 0=disabled
                            oid: snStackingGlobalConfigState.0
                            op: '!='
                            value: 1
                        -
                            # Fallback: Skip if this does NOT appear to be a stacking system
                            # Check sysDescr for stacking indicators
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '!~'
                            value: '(Stacking System|Stack|FCX.*Stack)'
                        -
                            # Check sysName for stack patterns (e.g., hostname_stack)
                            oid: SNMPv2-MIB::sysName.0
                            op: '!~'
                            value: '_stack$'
                        -
                            # Alternative: Check if stack-aware hardware tables exist
                            oid: snChasPwrSupply2OperStatus.1.1
                            op: 'not_exists'
                -
                    # Power Supply monitoring - Single switch version (fallback for non-stacking)
                    # Index format: psu (e.g., 1 = PSU 1, 2 = PSU 2) - single unit only
                    # Table: snChasPwrSupplyTable (.1.3.6.1.4.1.1991.1.1.1.2.1) - single unit data
                    oid: snChasPwrSupplyTable
                    value: snChasPwrSupplyOperStatus
                    num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.1.1.3.{{ $index }}'
                    descr: '{{ $snChasPwrSupplyDescription }}'
                    index: '{{ $index }}'
                    group: Power Supply
                    state_name: snChasPwrSupplyOperStatus
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: normal, graph: 1, generic: 0 }
                        - { value: 3, descr: failure, graph: 0, generic: 2 }
                    skip_values:
                        -
                            # Skip if stacking IS enabled (use stack-aware OIDs instead)
                            # Check stack configuration state: 1=enabled, 0=disabled
                            oid: snStackingGlobalConfigState.0
                            op: '='
                            value: 1
                        -
                            # Fallback: Skip if this appears to be a stacking system
                            # Check sysDescr for stacking indicators
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '~'
                            value: '(Stacking System|Stack|FCX.*Stack)'
                        -
                            # Check sysName for stack patterns (e.g., hostname_stack)
                            oid: SNMPv2-MIB::sysName.0
                            op: '~'
                            value: '_stack$'
                        -
                            # Alternative: Skip if stack-aware hardware tables exist
                            oid: snChasPwrSupply2OperStatus.1.1
                            op: 'exists'
                -
                    # Fan monitoring - Stack-aware version (WORKS on IronWare 08.0.30uT7f1!)
                    # Index format: unit.fan (e.g., 1.1 = unit 1 fan 1, 2.1 = unit 2 fan 1)
                    # Table: snChasFan2Table (.1.3.6.1.4.1.1991.1.1.1.3.2) - stack-wide fan data
                    # Provides monitoring for ALL 6 stack units on your FCX648!
                    oid: snChasFan2Table
                    value: snChasFan2OperStatus
                    num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.2.1.4.{{ $index }}'
                    descr: 'Unit {{ $snChasFan2Unit }} {{ $snChasFan2Description }}'
                    index: 'snChasFan2OperStatus.{{ $index }}'
                    group: Fan Status
                    state_name: snChasFan2OperStatus
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: normal, graph: 1, generic: 0 }
                        - { value: 3, descr: failure, graph: 0, generic: 2 }
                    skip_values:
                        -
                            # Skip if stacking is NOT enabled (use standalone OIDs instead)
                            # Check stack configuration state: 1=enabled, 0=disabled
                            oid: snStackingGlobalConfigState.0
                            op: '!='
                            value: 1
                        -
                            # Fallback: Skip if this does NOT appear to be a stacking system
                            # Check sysDescr for stacking indicators
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '!~'
                            value: '(Stacking System|Stack|FCX.*Stack)'
                        -
                            # Check sysName for stack patterns (e.g., hostname_stack)
                            oid: SNMPv2-MIB::sysName.0
                            op: '!~'
                            value: '_stack$'
                        -
                            # Alternative: Check if stack-aware hardware tables exist
                            oid: snChasPwrSupply2OperStatus.1.1
                            op: 'not_exists'
                -
                    # Fan monitoring - Single switch version (fallback for non-stacking)
                    # Index format: fan (e.g., 1 = fan 1) - single unit only
                    # Table: snChasFanTable (.1.3.6.1.4.1.1991.1.1.1.3.1) - single unit data
                    oid: snChasFanTable
                    value: snChasFanOperStatus
                    num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.1.1.3.{{ $index }}'
                    descr: '{{ $snChasFanDescription }}'
                    index: 'snChasFanOperStatus.{{ $index }}'
                    group: Fan Status
                    state_name: snChasFanOperStatus
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: normal, graph: 1, generic: 0 }
                        - { value: 3, descr: failure, graph: 0, generic: 2 }
                    skip_values:
                        -
                            # Skip if stacking IS enabled (use stack-aware OIDs instead)
                            # Check stack configuration state: 1=enabled, 0=disabled
                            oid: snStackingGlobalConfigState.0
                            op: '='
                            value: 1
                        -
                            # Fallback: Skip if this appears to be a stacking system
                            # Check sysDescr for stacking indicators
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '~'
                            value: '(Stacking System|Stack|FCX.*Stack)'
                        -
                            # Check sysName for stack patterns (e.g., hostname_stack)
                            oid: SNMPv2-MIB::sysName.0
                            op: '~'
                            value: '_stack$'
                        -
                            # Alternative: Skip if stack-aware hardware tables exist
                            oid: snChasPwrSupply2OperStatus.1.1
                            op: 'exists'
                -
                    # Fan monitoring - Single switch version (works for both standalone and stacking)
                    # On stacking systems, this table provides stack-wide fan data with unit information
                    # Index format: fan (e.g., 1 = fan 1) - but descriptions include unit info
                    # Table: snChasFanTable (.1.3.6.1.4.1.1991.1.1.1.3.1) - provides stack-wide data
                    oid: snChasFanTable
                    value: snChasFanOperStatus
                    num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.1.1.3.{{ $index }}'
                    descr: '{{ $snChasFanDescription }}'
                    index: 'snChasFanOperStatus.{{ $index }}'
                    group: Fan Status
                    state_name: snChasFanOperStatus
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: normal, graph: 1, generic: 0 }
                        - { value: 3, descr: failure, graph: 0, generic: 2 }
                -
                    oid: snStackingGlobalConfigState
                    value: snStackingGlobalConfigState
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.1.1.{{ $index }}'
                    descr: 'Stack Configuration'
                    index: 'snStackingGlobalConfigState.{{ $index }}'
                    group: Stack Status
                    state_name: snStackingGlobalConfigState
                    states:
                        - { value: 0, descr: none, graph: 0, generic: 3 }
                        - { value: 1, descr: enabled, graph: 1, generic: 0 }
                        - { value: 2, descr: disabled, graph: 0, generic: 1 }
                -
                    oid: snStackingOperUnitTable
                    value: snStackingOperUnitState
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.5.{{ $index }}'
                    descr: 'Unit {{ $index }} State'
                    index: 'snStackingOperUnitState.{{ $index }}'
                    skip_values:
                        -
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '!~'
                            value: 'Stacking System'
                    group: Stack Status
                    state_name: snStackingOperUnitState
                    states:
                        - { value: 1, descr: local, graph: 1, generic: 0 }
                        - { value: 2, descr: remote, graph: 1, generic: 0 }
                        - { value: 3, descr: reserved, graph: 0, generic: 2 }
                        - { value: 4, descr: empty, graph: 0, generic: 2 }
                -
                    oid: snStackingOperUnitTable
                    value: snStackingOperUnitRole
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.{{ $index }}'
                    descr: 'Unit {{ $index }} Role'
                    index: 'snStackingOperUnitRole.{{ $index }}'
                    skip_values:
                        -
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '!~'
                            value: 'Stacking System'
                    group: Stack Status
                    state_name: snStackingOperUnitRole
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: active, graph: 1, generic: 0 }
                        - { value: 3, descr: standby, graph: 1, generic: 0 }
                        - { value: 4, descr: member, graph: 1, generic: 0 }
                        - { value: 5, descr: standalone, graph: 1, generic: 0 }
                -
                    oid: snStackingOperUnitTable
                    value: snStackingOperUnitStackPort1State
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.8.{{ $index }}'
                    descr: 'Unit {{ $index }} Stack Port 1 → Unit {{ $snStackingOperUnitNeighbor1 }}'
                    index: 'snStackingOperUnitStackPort1State.{{ $index }}'
                    skip_values:
                        -
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '!~'
                            value: 'Stacking System'
                        -
                            oid: snStackingOperUnitStackPort1
                            op: '='
                            value: 0
                    group: Stack Ports
                    state_name: snStackingOperUnitStackPortState
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: up, graph: 1, generic: 0 }
                        - { value: 3, descr: down, graph: 0, generic: 2 }
                -
                    oid: snStackingOperUnitTable
                    value: snStackingOperUnitStackPort2State
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.10.{{ $index }}'
                    descr: 'Unit {{ $index }} Stack Port 2 → Unit {{ $snStackingOperUnitNeighbor2 }}'
                    index: 'snStackingOperUnitStackPort2State.{{ $index }}'
                    skip_values:
                        -
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '!~'
                            value: 'Stacking System'
                        -
                            oid: snStackingOperUnitStackPort2
                            op: '='
                            value: 0
                    group: Stack Ports
                    state_name: snStackingOperUnitStackPortState
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: up, graph: 1, generic: 0 }
                        - { value: 3, descr: down, graph: 0, generic: 2 }
                -
                    # Module status monitoring - Stack-aware version (used when stacking enabled)
                    # Index format: unit.slot (e.g., 1.1 = unit 1 slot 1, 2.1 = unit 2 slot 1)
                    # Table: snAgentBrd2Table (.1.3.6.1.4.1.1991.1.1.2.2.2) - stack-wide module status
                    oid: snAgentBrd2Table
                    value: snAgentBrd2ModuleStatus
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.2.1.6.{{ $index }}'
                    descr: 'Unit {{ $snAgentBrd2Unit }}/{{ $snAgentBrd2Slot }} {{ $snAgentBrd2MainBrdDescription }}'
                    index: 'snAgentBrd2ModuleStatus.{{ $index }}'
                    skip_values:
                        -
                            # Skip if this is not a stacking system (check sysDescr for "Stacking System")
                            oid: SNMPv2-MIB::sysDescr.0
                            op: '!~'
                            value: 'Stacking System'
                    group: Module Status
                    state_name: snAgentBrd2ModuleStatus
                    states:
                        - { value: 0, descr: moduleEmpty, graph: 0, generic: 2 }
                        - { value: 2, descr: moduleGoingDown, graph: 0, generic: 1 }
                        - { value: 3, descr: moduleRejected, graph: 0, generic: 2 }
                        - { value: 4, descr: moduleBad, graph: 0, generic: 2 }
                        - { value: 8, descr: moduleConfigured, graph: 1, generic: 0 }
                        - { value: 9, descr: moduleComingUp, graph: 0, generic: 1 }
                        - { value: 10, descr: moduleRunning, graph: 1, generic: 0 }
                        - { value: 11, descr: moduleBlocked, graph: 0, generic: 2 }

# Layer 2 switch with light L3 (static routes, EIGRP, RIP). Only modules useful for
# monitoring this role are enabled; all others (Cisco-specific, server/desktop, etc.)
# are explicitly disabled.
discovery_modules:
    # Core functionality for Brocade stack switches
    os: true
    ports: true
    ports-stack: true  # Stack port monitoring
    sensors: true      # All sensor types
    mempools: true     # Memory monitoring
    processors: true   # CPU monitoring

    # Network protocols
    lldp: true         # Link layer discovery
    stp: true          # Spanning tree protocol
    vlans: true        # VLAN discovery

    # Address management
    ipv4-addresses: true
    ipv6-addresses: true
    fdb-table: true    # Forwarding database

    # Routing (light L3)
    route: true        # Basic routing table

    # Disabled: Unused protocols and features
    arp-table: false
    bgp: false
    cisco-cef: false
    cisco-mac-accounting: false
    cisco-otv: false
    cisco-pw: false
    cisco-vrf-lite: false
    discovery-arp: false
    discovery-protocols: false
    entity-physical: false  # FCX/ICX lack ENTITY-MIB
    entity-state: false
    hr-device: false   # Host resources (server-focused)
    ospf: false
    ospfv3: false
    slas: false        # Service level agreements
    storage: false     # Disk/storage monitoring
    vrf: false         # Virtual routing/forwarding

poller_modules:
    # Enabled: L2 switch + light L3
    availability: true
    entity-physical: false  # Matches discovery; no ENTITY-MIB on these devices
    lldp: true
    ntp: false
    os: true
    ports: true
    sensors: true
    stp: true
    storage: false
    # Disabled: Cisco-specific, server/desktop, routing protocols, load balancers, etc.
    applications: false
    aruba-controller: false
    bgp-peers: false
    cipsec-tunnels: false
    cisco-ace-loadbalancer: false
    cisco-ace-serverfarms: false
    cisco-cbqos: false
    cisco-cef: false
    cisco-ipsec-flow-monitor: false
    cisco-mac-accounting: false
    cisco-otv: false
    cisco-remote-access-monitor: false
    cisco-vpdn: false
    entity-state: true
    hr-mib: true
    ipmi: false
    ipSystemStats: false
    junose-atm-vp: false
    loadbalancers: false
    mef: false
    mempools: true
    nac: false
    netstats: true
    ospf: false
    ospfv3: false
    printer-supplies: false
    processors: true
    services: false
    slas: false
    ucd-diskio: false
    ucd-mib: false
    unix-agent: false
    vminfo: false
    wireless: false
    netscaler-vsvr: false

stackable: true
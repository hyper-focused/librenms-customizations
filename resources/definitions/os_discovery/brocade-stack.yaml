# Brocade Stack OS Discovery - FastIron + ICX stackable switches
# Foundry enterprise OID only: .1.3.6.1.4.1.1991
# OIDs VERIFIED against FCX648 6-unit stack running IronWare 08.0.30uT7f1
# Testing date: 2026-02-04
#
# IMPORTANT: Power supply tables are mutually exclusive:
#   - snChasPwrSupply2Table: Stacked (unit.ps indexing)
#   - snChasPwrSupplyTable: Standalone (ps indexing only)
---
mib: FOUNDRY-SN-AGENT-MIB
modules:
  mempools:
    data:
      - total: FOUNDRY-SN-AGENT-MIB::snAgSystemDRAMTotal
        free: FOUNDRY-SN-AGENT-MIB::snAgSystemDRAMFree
        descr: 'System Memory'
  os:
    hardware_mib: FOUNDRY-SN-ROOT-MIB
    sysDescr_regex: '/(?:IronWare|FastIron) Version (?<version>[\d.]+[a-z\d]*)/'
    hardware_regex: '/(?:FCX|FWS|FLS|ICX)\d*[A-Z0-9-]*/i'
    serial: FOUNDRY-SN-AGENT-MIB::snChasSerNum.0
    version: FOUNDRY-SN-AGENT-MIB::snAgImgVer.0
  processors:
    data:
      # Stack-wide CPU averages (global for entire stack)
      - oid: FOUNDRY-SN-AGENT-MIB::snAgGblCpuUtil1SecAvg
        value: FOUNDRY-SN-AGENT-MIB::snAgGblCpuUtil1SecAvg
        num_oid: '.1.3.6.1.4.1.1991.1.1.2.11.1.0'
        descr: 'Stack-wide CPU 1sec avg'
        index: 'stack.1sec'
      - oid: FOUNDRY-SN-AGENT-MIB::snAgGblCpuUtil5SecAvg
        value: FOUNDRY-SN-AGENT-MIB::snAgGblCpuUtil5SecAvg
        num_oid: '.1.3.6.1.4.1.1991.1.1.2.11.2.0'
        descr: 'Stack-wide CPU 5sec avg'
        index: 'stack.5sec'
      - oid: FOUNDRY-SN-AGENT-MIB::snAgGblCpuUtil1MinAvg
        value: FOUNDRY-SN-AGENT-MIB::snAgGblCpuUtil1MinAvg
        num_oid: '.1.3.6.1.4.1.1991.1.1.2.11.3.0'
        descr: 'Stack-wide CPU 1min avg'
        index: 'stack.1min'
      # Per-unit CPU utilization table
      # Index format: {slot}.{cpuId}.{interval}
      # Intervals: 1=1sec, 5=5sec, 60=1min, 300=5min
      # We use interval=1 (1 second average) for real-time monitoring
      - oid: FOUNDRY-SN-AGENT-MIB::snAgentCpuUtilTable
        value: FOUNDRY-SN-AGENT-MIB::snAgentCpuUtilPercent
        num_oid: '.1.3.6.1.4.1.1991.1.1.2.11.1.1.5.{{ $index }}'
        descr: 'Unit {{ $subindex0 }} CPU {{ $subindex1 }}'
        index: '{{ $index }}'
        skip_value:
          # Only include 1-second interval (snAgentCpuUtilInterval = 1)
          - oid: snAgentCpuUtilInterval
            op: '!='
            value: 1
  sensors:
    temperature:
      data:
        # Module Temperatures - Base sensor table
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentTempTable
          value: FOUNDRY-SN-AGENT-MIB::snAgentTempValue
          divisor: 2
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.1.1.4.{{ $index }}'
          descr: snAgentTempSensorDescr
          index: '{{ $index }}'
          group: 'Module Temperatures'
        # Module Temperatures - Extended sensor table (per-unit)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentTemp2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentTemp2Value
          divisor: 2
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.3.1.5.{{ $index }}'
          descr: 'Unit {{ $subindex0 }}/{{ $subindex1 }} Sensor'
          index: '{{ $index }}'
          group: 'Module Temperatures'
    state:
      data:
        # Power Supply Status - Table 1 (standard/standalone)
        # Returns: 1=other, 2=normal, 3=failure
        - oid: FOUNDRY-SN-AGENT-MIB::snChasPwrSupplyTable
          value: FOUNDRY-SN-AGENT-MIB::snChasPwrSupplyOperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.1.1.3.{{ $index }}'
          descr: 'Power Supply {{ $index }}'
          index: '{{ $index }}'
          group: 'Power Supply Status'
          state_name: snChasPwrSupplyOperStatus
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: normal, graph: 1, generic: 0}
            - {value: 3, descr: failure, graph: 0, generic: 2}
        # Power Supply Status - Table 2 (stacked configurations)
        # Index format: {unit}.{ps_number} (e.g., 1.1, 1.2, 2.1, 2.2)
        # Returns: 1=other, 2=normal, 3=failure
        - oid: FOUNDRY-SN-AGENT-MIB::snChasPwrSupply2Table
          value: FOUNDRY-SN-AGENT-MIB::snChasPwrSupply2OperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.2.1.4.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Power Supply {{ $subindex1 }}'
          index: '{{ $index }}'
          group: 'Power Supply Status'
          state_name: snChasPwrSupply2OperStatus
          skip_values:
            - oid: "SNMPv2-MIB::sysDescr.0"
              op: "!~"
              value: "Stacking System"
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: normal, graph: 1, generic: 0}
            - {value: 3, descr: failure, graph: 0, generic: 2}
        # Fan Status - Table 1 (standard/standalone)
        # Returns: 1=other, 2=normal, 3=failure
        - oid: FOUNDRY-SN-AGENT-MIB::snChasFanTable
          value: FOUNDRY-SN-AGENT-MIB::snChasFanOperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.1.1.3.{{ $index }}'
          descr: 'Fan {{ $index }}'
          index: '{{ $index }}'
          group: 'Fan Status'
          state_name: snChasFanOperStatus
          skip_values:
            - oid: "SNMPv2-MIB::sysDescr.0"
              op: "=~"
              value: "Stacking System"
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: normal, graph: 1, generic: 0}
            - {value: 3, descr: failure, graph: 0, generic: 2}
        # Fan Status - Table 2 (stacked configurations)
        # Index format: {unit}.{fan_index} (e.g., 1.1, 1.2, 2.1, 2.2)
        # Returns: 1=other, 2=normal, 3=failure
        - oid: FOUNDRY-SN-AGENT-MIB::snChasFan2Table
          value: FOUNDRY-SN-AGENT-MIB::snChasFan2OperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.2.1.4.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Fan {{ $subindex1 }}'
          index: '{{ $index }}'
          group: 'Fan Status'
          state_name: snChasFan2OperStatus
          skip_values:
            - oid: "SNMPv2-MIB::sysDescr.0"
              op: "!~"
              value: "Stacking System"
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: normal, graph: 1, generic: 0}
            - {value: 3, descr: failure, graph: 0, generic: 2}

        # Board Module Status - Per-unit board operational status (stacked)
        # Index format: {unit}.{slot} (e.g., 1.1, 2.1, 3.1)
        # Returns: 0=empty, 2=goingDown, 3=rejected, 4=bad, 8=configured, 9=comingUp, 10=running
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentBrd2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentBrd2ModuleStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.2.1.6.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Slot {{ $subindex1 }} Module'
          index: '{{ $index }}'
          group: 'Board Status'
          state_name: snAgentBrd2ModuleStatus
          skip_values:
            - oid: "SNMPv2-MIB::sysDescr.0"
              op: "!~"
              value: "Stacking System"
          states:
            - {value: 0, descr: empty, graph: 0, generic: 3}
            - {value: 2, descr: goingDown, graph: 0, generic: 2}
            - {value: 3, descr: rejected, graph: 0, generic: 2}
            - {value: 4, descr: bad, graph: 0, generic: 2}
            - {value: 8, descr: configured, graph: 1, generic: 0}
            - {value: 9, descr: comingUp, graph: 1, generic: 0}
            - {value: 10, descr: running, graph: 1, generic: 0}
        # Board Redundancy Status - Per-unit redundancy status (stacked)
        # Index format: {unit}.{slot} (e.g., 1.1, 2.1, 3.1)
        # Returns: 1=other, 2=active, 3=standby, 4=crashed, 5=comingUp
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentBrd2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentBrd2RedundantStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.2.1.7.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Slot {{ $subindex1 }} Redundancy'
          index: '{{ $index }}'
          group: 'Board Status'
          state_name: snAgentBrd2RedundantStatus
          skip_values:
            - oid: "SNMPv2-MIB::sysDescr.0"
              op: "!~"
              value: "Stacking System"
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: active, graph: 1, generic: 0}
            - {value: 3, descr: standby, graph: 1, generic: 0}
            - {value: 4, descr: crashed, graph: 0, generic: 2}
            - {value: 5, descr: comingUp, graph: 1, generic: 0}

        # Stack Configuration State - DISABLED
        # This OID does NOT exist on firmware 08.0.30u
        # Commented out to prevent discovery errors
        # - oid: FOUNDRY-SN-SWITCH-GROUP-MIB::snStackingGlobalConfigState
        #   value: FOUNDRY-SN-SWITCH-GROUP-MIB::snStackingGlobalConfigState
        #   num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.1.1.0'
        #   descr: 'Stack Configuration'
        #   group: 'Stack Status'
        #   state_name: snStackingGlobalConfigState
        #   states:
        #     - { value: 0, descr: disabled, graph: 0, generic: 3 }
        #     - { value: 1, descr: enabled, graph: 1, generic: 0 }
        #     - { value: 2, descr: unsupported, graph: 0, generic: 2 }

        # Stack Unit State - Verified working on 6-unit stack
        # Returns: 1=local (master), 2=remote (members)
        - oid: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitTable
          value: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitState
          num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.5.{{ $index }}'
          descr: 'Unit {{ $index }} State'
          group: 'Stack Status'
          state_name: snStackingOperUnitState
          skip_values:
            - oid: "SNMPv2-MIB::sysDescr.0"
              op: "!~"
              value: "Stacking System"
          states:
            - {value: 1, descr: local, graph: 1, generic: 0}
            - {value: 2, descr: remote, graph: 1, generic: 0}
            - {value: 3, descr: reserved, graph: 0, generic: 2}
            - {value: 4, descr: empty, graph: 0, generic: 2}

        # Stack Unit Role - Verified working on 6-unit stack
        # Returns: 2=active (master), 3=standby, 4=member
        - oid: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitTable
          value: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitRole
          num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.{{ $index }}'
          descr: 'Unit {{ $index }} Role'
          group: 'Stack Status'
          state_name: snStackingOperUnitRole
          skip_values:
            - oid: "SNMPv2-MIB::sysDescr.0"
              op: "!~"
              value: "Stacking System"
          states:
            - {value: 1, descr: other, graph: 0, generic: 3}
            - {value: 2, descr: active, graph: 1, generic: 0}
            - {value: 3, descr: standby, graph: 1, generic: 0}
            - {value: 4, descr: member, graph: 1, generic: 0}
            - {value: 5, descr: standalone, graph: 1, generic: 0}

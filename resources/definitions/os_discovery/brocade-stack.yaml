# Brocade Stack OS Discovery - FastIron + ICX stackable switches
# Foundry enterprise OID: .1.3.6.1.4.1.1991
#
# Stacked vs Standalone Detection:
#   OID .1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1 (snStackingOperUnitRole for unit 1)
#   Returns 2/3/4 on stacking systems, 5 on standalone
#
# Table naming convention:
#   Table 2 (e.g., snChasFan2Table) = stacked, index: {unit}.{item}
#   Table 1 (e.g., snChasFanTable)  = standalone, index: {item}
---
mib: FOUNDRY-SN-AGENT-MIB
modules:
  mempools:
    data:
      # Numerical OIDs required â€” LibreNMS MIB can't resolve symbolic names
      - total: .1.3.6.1.4.1.1991.1.1.2.1.54.0
        free: .1.3.6.1.4.1.1991.1.1.2.1.55.0
        descr: 'System Memory'
  os:
    hardware_mib: FOUNDRY-SN-ROOT-MIB
    sysDescr_regex: '/(?:IronWare|FastIron) Version (?<version>[\d.]+[a-z\d]*)/'
    hardware_regex: '/(?:FCX|FWS|FLS|ICX)\d*[A-Z0-9-]*/i'
    serial: FOUNDRY-SN-AGENT-MIB::snChasSerNum.0
    version: FOUNDRY-SN-AGENT-MIB::snAgImgVer.0
  processors:
    data:
      # Index: {unit}.{slot}.{cpu_num}.{interval}
      - oid: FOUNDRY-SN-AGENT-MIB::snAgentCpuUtilTable
        value: FOUNDRY-SN-AGENT-MIB::snAgentCpuUtilPercent
        num_oid: '.1.3.6.1.4.1.1991.1.1.2.11.1.1.5.{{ $index }}'
        descr: 'Unit {{ $subindex0 }} CPU Utilization ({{ $subindex1 }}s)'
        index: '{{ $index }}'
  sensors:
    temperature:
      data:
        # Temperature - stacked (skip on standalone)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentTemp2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentTemp2Value
          divisor: 2
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.3.1.5.{{ $index }}'
          descr: 'Unit {{ $subindex0 }}: '
          index: '{{ $index }}'
          group: 'Temperature Sensors'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
        # Temperature - standalone (skip on stacked)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentTempTable
          value: FOUNDRY-SN-AGENT-MIB::snAgentTempValue
          divisor: 2
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.1.1.4.{{ $index }}'
          descr: 'Temperature Sensor {{ $index }}'
          index: '{{ $index }}'
          group: 'Temperature Sensors'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "!="
              value: 5
    state:
      data:
        # Power Supply - standalone (skip on stacked)
        - oid: FOUNDRY-SN-AGENT-MIB::snChasPwrSupplyTable
          value: FOUNDRY-SN-AGENT-MIB::snChasPwrSupplyOperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.1.1.3.{{ $index }}'
          descr: 'Power Supply {{ $index }} Status'
          index: '{{ $index }}'
          group: 'Power Supply Status'
          state_name: 'Power Supply {{ $index }}'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "!="
              value: 5
          states:
            - {value: 1, descr: Other, graph: 0, generic: 3}
            - {value: 2, descr: Normal, graph: 0, generic: 0}
            - {value: 3, descr: Failed, graph: 0, generic: 2}
        # Power Supply - stacked (skip on standalone)
        - oid: FOUNDRY-SN-AGENT-MIB::snChasPwrSupply2Table
          value: FOUNDRY-SN-AGENT-MIB::snChasPwrSupply2OperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.2.1.4.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Power Supply {{ $subindex1 }} Status'
          index: '{{ $index }}'
          group: 'Power Supply Status'
          state_name: 'Power Supply {{ $subindex0 }}.{{ $subindex1 }}'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 1, descr: Other, graph: 0, generic: 3}
            - {value: 2, descr: Normal, graph: 0, generic: 0}
            - {value: 3, descr: Failed, graph: 0, generic: 2}
        # Fan - standalone (skip on stacked)
        - oid: FOUNDRY-SN-AGENT-MIB::snChasFanTable
          value: FOUNDRY-SN-AGENT-MIB::snChasFanOperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.1.1.3.{{ $index }}'
          descr: 'Fan {{ $index }} Status'
          index: '{{ $index }}'
          group: 'Fan Status'
          state_name: 'Fan {{ $index }}'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "!="
              value: 5
          states:
            - {value: 1, descr: Other, graph: 0, generic: 3}
            - {value: 2, descr: Normal, graph: 0, generic: 0}
            - {value: 3, descr: Failed, graph: 0, generic: 2}
        # Fan - stacked (skip on standalone)
        - oid: FOUNDRY-SN-AGENT-MIB::snChasFan2Table
          value: FOUNDRY-SN-AGENT-MIB::snChasFan2OperStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.2.1.4.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Fan {{ $subindex1 }} Status'
          index: '{{ $index }}'
          group: 'Fan Status'
          state_name: 'Fan {{ $subindex0 }}.{{ $subindex1 }}'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 1, descr: Other, graph: 0, generic: 3}
            - {value: 2, descr: Normal, graph: 0, generic: 0}
            - {value: 3, descr: Failed, graph: 0, generic: 2}

        # Board Module Status - stacked (skip on standalone)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentBrd2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentBrd2ModuleStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.2.1.6.{{ $index }}'
          descr: 'Unit {{ $subindex0 }} Module {{ $subindex1 }} Status'
          index: '{{ $index }}'
          group: 'Switch Modules'
          state_name: 'Switch Module {{ $subindex0 }}.{{ $subindex1 }}'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 0, descr: Empty, graph: 0, generic: 3}
            - {value: 2, descr: Stopping, graph: 0, generic: 1}
            - {value: 3, descr: Rejected, graph: 0, generic: 2}
            - {value: 4, descr: Failed, graph: 0, generic: 2}
            - {value: 8, descr: Configured, graph: 0, generic: 1}
            - {value: 9, descr: Starting, graph: 0, generic: 1}
            - {value: 10, descr: Running, graph: 0, generic: 0}
        # Board Module Status - standalone (skip on stacked)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentBrdTable
          value: FOUNDRY-SN-AGENT-MIB::snAgentBrdModuleStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.1.1.12.{{ $index }}'
          descr: 'Module {{ $index }} Status'
          index: '{{ $index }}'
          group: 'Switch Modules'
          state_name: 'Switch Module {{ $index }}'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "!="
              value: 5
          states:
            - {value: 0, descr: Empty, graph: 0, generic: 3}
            - {value: 2, descr: Stopping, graph: 0, generic: 1}
            - {value: 3, descr: Rejected, graph: 0, generic: 2}
            - {value: 4, descr: Failed, graph: 0, generic: 2}
            - {value: 8, descr: Configured, graph: 0, generic: 1}
            - {value: 9, descr: Starting, graph: 0, generic: 1}
            - {value: 10, descr: Running, graph: 0, generic: 0}
        # Board Redundancy - stacked (skip on standalone)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentBrd2Table
          value: FOUNDRY-SN-AGENT-MIB::snAgentBrd2RedundantStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.2.1.7.{{ $index }}'
          descr: 'Switch {{ $subindex0 }}.{{ $subindex1 }} Management'
          index: '{{ $index }}'
          group: 'Stack Topology'
          state_name: 'Switch {{ $subindex0 }}.{{ $subindex1 }} Management'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 1, descr: Other, graph: 0, generic: 3}
            - {value: 2, descr: Active, graph: 0, generic: 0}
            - {value: 3, descr: Standby, graph: 0, generic: 0}
            - {value: 4, descr: Crashed, graph: 0, generic: 2}
            - {value: 5, descr: Starting, graph: 0, generic: 1}
        # Board Redundancy - standalone (skip on stacked)
        - oid: FOUNDRY-SN-AGENT-MIB::snAgentBrdTable
          value: FOUNDRY-SN-AGENT-MIB::snAgentBrdRedundantStatus
          num_oid: '.1.3.6.1.4.1.1991.1.1.2.2.1.1.13.{{ $index }}'
          descr: 'Switch {{ $index }} Management Redundancy'
          index: '{{ $index }}'
          group: 'Stack Topology'
          state_name: 'Management Redundancy Status'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "!="
              value: 5
          states:
            - {value: 1, descr: Other, graph: 0, generic: 3}
            - {value: 2, descr: Active, graph: 0, generic: 0}
            - {value: 3, descr: Standby, graph: 0, generic: 0}
            - {value: 4, descr: Crashed, graph: 0, generic: 2}
            - {value: 5, descr: Starting, graph: 0, generic: 1}

        # Stack Unit State - stacked only (skip on standalone)
        - oid: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitTable
          value: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitState
          num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.5.{{ $index }}'
          descr: 'Unit {{ $index }} Management View'
          group: 'Stack Topology'
          state_name: 'Unit {{ $index }} Management View'
          skip_values:
            - oid: ".1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.1"
              op: "="
              value: 5
          states:
            - {value: 1, descr: Local, graph: 0, generic: 0}
            - {value: 2, descr: Remote, graph: 0, generic: 0}
            - {value: 3, descr: Reserved, graph: 0, generic: 1}
            - {value: 4, descr: Empty, graph: 0, generic: 2}

        # Stack Unit Role - both stacked and standalone (returns 5=Standalone)
        - oid: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitTable
          value: FOUNDRY-SN-STACKING-MIB::snStackingOperUnitRole
          num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.2.{{ $index }}'
          descr: 'Unit {{ $index }} Stack Role'
          group: 'Stack Topology'
          state_name: 'Unit {{ $index }} Stack Role'
          states:
            - {value: 1, descr: "Other / Unknown", graph: 0, generic: 3}
            - {value: 2, descr: "Stack Master", graph: 0, generic: 0}
            - {value: 3, descr: "Stack Standby", graph: 0, generic: 0}
            - {value: 4, descr: "Stack Member", graph: 0, generic: 0}
            - {value: 5, descr: "Standalone", graph: 0, generic: 0}

    # PoE sensors handled in PHP: includes/discovery/sensors/power/brocade-stack.inc.php
    # (YAML can't resolve numerical OIDs when MIBs are loaded, and port linking needs ifIndex mapping)

# Brocade Stack OS Discovery
# Single unified discovery: FastIron (FCX, FWS, FLS, etc.) + ICX stackable switches
# Shared MIBs and logic for both platforms; stack-aware per-unit discovery

mib: FOUNDRY-SN-AGENT-MIB:FOUNDRY-SN-SWITCH-GROUP-MIB:FOUNDRY-SN-STACKING-MIB
modules:
    mempools:
        additional_oids:
            oids:
                - FOUNDRY-SN-AGENT-MIB::snAgentBrdMainBrdDescription
                - FOUNDRY-SN-AGENT-MIB::snAgentConfigModuleDescription
        data:
            -
                # Global system memory (stack master)
                total: FOUNDRY-SN-AGENT-MIB::snAgSystemDRAMTotal
                free: FOUNDRY-SN-AGENT-MIB::snAgSystemDRAMFree
                descr: 'System Memory'
                type: brocade-system
            -
                # Per-unit/per-module memory (stack-aware via index)
                # Index represents unit/module in stacked systems
                total: FOUNDRY-SN-AGENT-MIB::snAgentBrdMemoryTotal
                percent_used: FOUNDRY-SN-AGENT-MIB::snAgentBrdMemoryUtil100thPercent
                type: brocade-dyn
                descr: 'Unit {{ $index }} {{ FOUNDRY-SN-AGENT-MIB::snAgentBrdMainBrdDescription }}'
    
    os:
        hardware_mib: FOUNDRY-SN-ROOT-MIB
        # Extract version from sysDescr
        # Matches: "IronWare Version 08.0.30uT7f1" or "FastIron Version 08.0.95"
        sysDescr_regex: '/(?:IronWare|FastIron) Version (?<version>[\d.]+[a-zA-Z0-9]*)/i'
        # Extract hardware from sysDescr (FastIron + ICX model names)
        # Matches: FCX648, FWS, FLS, ICX6450-48, ICX7150-48P, etc.
        hardware: 
            - FOUNDRY-SN-AGENT-MIB::snChasUnitDescription.1
        hardware_regex: '/(?:FCX|FWS|FLS|ICX)\d*[A-Z0-9-]*/i'
        serial: FOUNDRY-SN-AGENT-MIB::snChasSerNum.0
        version: FOUNDRY-SN-AGENT-MIB::snAgImgVer.0
    
    sensors:
        additional_oids:
            data:
                -
                    oid:
                        - ifDescr
                        - snAgentTemp2SensorDescr
        
        # Optical transceiver monitoring (interface-based, stack-aware)
        # Interfaces in stacks use format: unit/slot/port (e.g., 1/1/1, 2/1/1)
        # Modern format: group=transceiver, entPhysicalIndex_measured=ports
        # This makes transceiver data appear in Ports → Transceivers tab
        dbm:
            data:
                -
                    oid: snIfOpticalMonitoringInfoTable
                    value: snIfOpticalMonitoringRxPower
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.3.6.1.3.{{ $index }}'
                    descr: '{{ $ifDescr }} Rx Power'
                    index: 'rx-{{ $index }}'
                    entPhysicalIndex: '{{ $index }}'
                    entPhysicalIndex_measured: 'ports'
                    group: transceiver
                    skip_values: 0
                -
                    oid: snIfOpticalMonitoringInfoTable
                    value: snIfOpticalMonitoringTxPower
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.3.6.1.2.{{ $index }}'
                    descr: '{{ $ifDescr }} Tx Power'
                    index: 'tx-{{ $index }}'
                    entPhysicalIndex: '{{ $index }}'
                    entPhysicalIndex_measured: 'ports'
                    group: transceiver
                    skip_values: 0
        
        # Current monitoring (optical transceivers, interface-based/stack-aware)
        # Modern format: displays in Ports → Transceivers tab
        current:
            data:
                -
                    oid: snIfOpticalMonitoringInfoTable
                    value: snIfOpticalMonitoringTxBiasCurrent
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.3.6.1.4.{{ $index }}'
                    descr: '{{ $ifDescr }} Tx Bias'
                    divisor: 1000
                    index: 'bias-{{ $index }}'
                    entPhysicalIndex: '{{ $index }}'
                    entPhysicalIndex_measured: 'ports'
                    group: transceiver
                    skip_values: 0
        
        # PoE monitoring
        count:
            data:
                -
                    oid: FOUNDRY-POE-MIB::snAgentPoeGblPowerAllocationsRequestsHonored
                    value: FOUNDRY-POE-MIB::snAgentPoeGblPowerAllocationsRequestsHonored
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.1.3.{{ $index }}'
                    index: 'snAgentPoeGblPowerAllocationsRequestsHonored.{{ $index }}'
                    descr: 'PoE Allocations Honored'
                -
                    oid: FOUNDRY-POE-MIB::snAgentPoeUnitTable
                    value: FOUNDRY-POE-MIB::snAgentPoeUnitPowerAllocationsRequestsHonored
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.4.1.1.4.{{ $index }}'
                    index: 'snAgentPoeUnitPowerAllocationsRequestsHonored.{{ $index }}'
                    group: 'Unit PoE'
                    descr: 'Unit {{ $index }} PoE Allocations'
        
        # Power monitoring
        power:
            data:
                -
                    oid: FOUNDRY-POE-MIB::snAgentPoeGblPowerCapacityTotal
                    value: FOUNDRY-POE-MIB::snAgentPoeGblPowerCapacityTotal
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.1.1.{{ $index }}'
                    index: 'snAgentPoeGblPowerCapacityTotal.{{ $index }}'
                    group: 'Device PoE'
                    divisor: 1000
                    descr: 'Total PoE Capacity'
                -
                    oid: FOUNDRY-POE-MIB::snAgentPoeGblPowerCapacityFree
                    value: FOUNDRY-POE-MIB::snAgentPoeGblPowerCapacityFree
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.1.2.{{ $index }}'
                    index: 'snAgentPoeGblPowerCapacityFree.{{ $index }}'
                    group: 'Device PoE'
                    divisor: 1000
                    descr: 'Free PoE Capacity'
                -
                    oid: FOUNDRY-POE-MIB::snAgentPoePortTable
                    value: FOUNDRY-POE-MIB::snAgentPoePortConsumed
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.2.2.1.6.{{ $index }}'
                    index: 'snAgentPoePortConsumed.{{ $index }}'
                    group: 'Port PoE'
                    divisor: 1000
                    descr: 'Port {{ $ifDescr }} PoE Consumed'
                -
                    oid: FOUNDRY-POE-MIB::snAgentPoeUnitTable
                    value: FOUNDRY-POE-MIB::snAgentPoeUnitPowerCapacityTotal
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.4.1.1.2.{{ $index }}'
                    index: 'snAgentPoeUnitPowerCapacityTotal.{{ $index }}'
                    group: 'Unit PoE'
                    divisor: 1000
                    descr: 'Unit {{ $index }} Total PoE Power'
                -
                    oid: FOUNDRY-POE-MIB::snAgentPoeUnitTable
                    value: FOUNDRY-POE-MIB::snAgentPoeUnitPowerCapacityFree
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.14.4.1.1.3.{{ $index }}'
                    index: 'snAgentPoeUnitPowerCapacityFree.{{ $index }}'
                    group: 'Unit PoE'
                    divisor: 1000
                    descr: 'Unit {{ $index }} Free PoE Power'
        
        # Temperature monitoring (stack-aware)
        temperature:
            data:
                -
                    # Legacy temperature table (use only if Temp2 not available)
                    oid: snAgentTempTable
                    value: snAgentTempValue
                    divisor: 2
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.1.1.4.{{ $index }}'
                    descr: snAgentTempSensorDescr
                    index: '{{ $index }}'
                    group: 'Module Temperatures'
                    skip_values:
                        -
                            oid: snAgentTemp2SensorDescr.1.1.1
                            op: 'exists'
                            value: true
                -
                    # Stack-aware temperature table (per-unit indexed)
                    # Index format: unit.slot.sensor (e.g., 1.1.1 = unit 1, slot 1, sensor 1)
                    # subindex0 = unit ID, subindex1 = slot, subindex2 = sensor
                    oid: snAgentTemp2Table
                    value: snAgentTemp2Value
                    divisor: 2
                    num_oid: '.1.3.6.1.4.1.1991.1.1.2.13.3.1.5.{{ $index }}'
                    descr: 'Unit {{ $subindex0 }}/{{ $subindex1 }} {{ $snAgentTemp2SensorDescr }}'
                    index: '{{ $index }}'
                    group: 'Stack Unit Temperatures'
                -
                    # Optical transceiver temperature (interface-based, stack-aware)
                    # Modern format: displays in Ports → Transceivers tab
                    oid: snIfOpticalMonitoringInfoTable
                    value: snIfOpticalMonitoringTemperature
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.3.6.1.1.{{ $index }}'
                    descr: '{{ $ifDescr }} Temp'
                    index: 'temp-{{ $index }}'
                    entPhysicalIndex: '{{ $index }}'
                    entPhysicalIndex_measured: 'ports'
                    group: transceiver
                    skip_values: 0
        
        # State sensors (PSU, Fan, Stack)
        state:
            data:
                -
                    # Power Supply monitoring (stack-aware via multi-level index)
                    # Index format: unit.psu (e.g., 1.1 = unit 1 PSU 1, 2.1 = unit 2 PSU 1)
                    oid: snChasPwrSupplyTable
                    value: snChasPwrSupplyOperStatus
                    num_oid: '.1.3.6.1.4.1.1991.1.1.1.2.1.1.3.{{ $index }}'
                    descr: 'Unit {{ $subindex0 }} {{ $snChasPwrSupplyDescription }}'
                    index: '{{ $index }}'
                    skip_values: 1
                    group: Power Supply
                    state_name: snChasPwrSupplyOperStatus
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: normal, graph: 1, generic: 0 }
                        - { value: 3, descr: failure, graph: 0, generic: 2 }
                -
                    # Fan monitoring (stack-aware via multi-level index)
                    # Index format: unit.fan (e.g., 1.1 = unit 1 fan 1, 2.1 = unit 2 fan 1)
                    oid: snChasFanTable
                    value: snChasFanOperStatus
                    num_oid: '.1.3.6.1.4.1.1991.1.1.1.3.1.1.3.{{ $index }}'
                    descr: 'Unit {{ $subindex0 }} {{ $snChasFanDescription }}'
                    index: 'snChasFanOperStatus.{{ $index }}'
                    group: Fan Status
                    state_name: snChasFanOperStatus
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: normal, graph: 1, generic: 0 }
                        - { value: 3, descr: failure, graph: 0, generic: 2 }
                -
                    oid: snStackingGlobalConfigState
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.1.1.{{ $index }}'
                    descr: 'Stack Configuration'
                    index: 'snStackingGlobalConfigState.{{ $index }}'
                    group: Stack Status
                    state_name: snStackingGlobalConfigState
                    states:
                        - { value: 0, descr: none, graph: 0, generic: 3 }
                        - { value: 1, descr: enabled, graph: 1, generic: 0 }
                        - { value: 2, descr: disabled, graph: 0, generic: 1 }
                -
                    oid: snStackingOperUnitTable
                    value: snStackingOperUnitState
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.5.{{ $index }}'
                    descr: 'Unit {{ $index }} State'
                    index: 'snStackingOperUnitState.{{ $index }}'
                    skip_values:
                        -
                            oid: snStackingGlobalConfigState.0
                            op: '!='
                            value: 1
                    group: Stack Status
                    state_name: snStackingOperUnitState
                    states:
                        - { value: 1, descr: local, graph: 1, generic: 0 }
                        - { value: 2, descr: remote, graph: 1, generic: 0 }
                        - { value: 3, descr: reserved, graph: 0, generic: 2 }
                        - { value: 4, descr: empty, graph: 0, generic: 2 }
                -
                    oid: snStackingOperUnitTable
                    value: snStackingOperUnitStackPort1State
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.8.{{ $index }}'
                    descr: 'Unit {{ $index }} Stack Port 1 → Unit {{ $snStackingOperUnitNeighbor1 }}'
                    index: 'snStackingOperUnitStackPort1State.{{ $index }}'
                    skip_values:
                        -
                            oid: snStackingGlobalConfigState.0
                            op: '!='
                            value: 1
                        -
                            oid: snStackingOperUnitStackPort1
                            op: '='
                            value: 0
                    group: Stack Ports
                    state_name: snStackingOperUnitStackPortState
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: up, graph: 1, generic: 0 }
                        - { value: 3, descr: down, graph: 0, generic: 2 }
                -
                    oid: snStackingOperUnitTable
                    value: snStackingOperUnitStackPort2State
                    num_oid: '.1.3.6.1.4.1.1991.1.1.3.31.2.2.1.10.{{ $index }}'
                    descr: 'Unit {{ $index }} Stack Port 2 → Unit {{ $snStackingOperUnitNeighbor2 }}'
                    index: 'snStackingOperUnitStackPort2State.{{ $index }}'
                    skip_values:
                        -
                            oid: snStackingGlobalConfigState.0
                            op: '!='
                            value: 1
                        -
                            oid: snStackingOperUnitStackPort2
                            op: '='
                            value: 0
                    group: Stack Ports
                    state_name: snStackingOperUnitStackPortState
                    states:
                        - { value: 1, descr: other, graph: 0, generic: 3 }
                        - { value: 2, descr: up, graph: 1, generic: 0 }
                        - { value: 3, descr: down, graph: 0, generic: 2 }

# Layer 2 switch with light L3 (static routes, EIGRP, RIP). Only modules useful for
# monitoring this role are enabled; all others (Cisco-specific, server/desktop, etc.)
# are explicitly disabled.
discovery_modules:
    # Enabled: L2 switch + light L3
    arp-table: true
    discovery-protocols: true
    entity-physical: true
    fdb-table: true
    ipv4-addresses: true
    ipv6-addresses: true
    lldp: true
    os: true
    ports: true
    ports-stack: true
    route: true
    sensors: true
    storage: true
    stp: true
    vlans: true
    # Disabled: routing protocols (BGP, OSPF), Cisco-specific, server/desktop, other
    bgp: false
    cisco-cef: false
    cisco-mac-accounting: false
    cisco-otv: false
    cisco-pw: false
    cisco-vrf-lite: false
    discovery-arp: false
    entity-state: false
    hr-device: false
    mempools: false
    ospf: false
    ospfv3: false
    processors: false
    slas: false
    vrf: false

poller_modules:
    # Enabled: L2 switch + light L3
    availability: true
    entity-physical: true
    lldp: true
    ntp: true
    os: true
    ports: true
    sensors: true
    stp: true
    storage: true
    # Disabled: Cisco-specific, server/desktop, routing protocols, load balancers, etc.
    applications: false
    aruba-controller: false
    bgp-peers: false
    cipsec-tunnels: false
    cisco-ace-loadbalancer: false
    cisco-ace-serverfarms: false
    cisco-cbqos: false
    cisco-cef: false
    cisco-ipsec-flow-monitor: false
    cisco-mac-accounting: false
    cisco-otv: false
    cisco-remote-access-monitor: false
    cisco-vpdn: false
    entity-state: false
    hr-mib: false
    ipmi: false
    ipSystemStats: false
    junose-atm-vp: false
    loadbalancers: false
    mef: false
    mempools: false
    nac: false
    netstats: false
    ospf: false
    ospfv3: false
    printer-supplies: false
    processors: false
    services: false
    slas: false
    ucd-diskio: false
    ucd-mib: false
    unix-agent: false
    vminfo: false
    wireless: false
    netscaler-vsvr: false

stackable: true
